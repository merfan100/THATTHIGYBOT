# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±ÙˆØ± ÙˆØ¨ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø± Ø­Ø§Ù„Øª Webhook --- import asyncio import warnings import os import traceback # Ø§ÛŒÙ…Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆØ± ÙˆØ¨ Flask Ùˆ Ø³Ø±ÙˆØ± ASGI Hypercorn from flask import Flask, request, jsonify from hypercorn.asyncio import serve from hypercorn.config import Config # Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Update Ø§Ø² Telegram Ùˆ Ù…Ø§Ú˜ÙˆÙ„ Ø¨Ø§Øª from telegram import Update import test2 # Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† ÙˆØ§Ø±Ù†ÛŒÙ†Ú¯â€ŒÙ‡Ø§ÛŒ jdatetime (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯) warnings.filterwarnings("ignore", category=SyntaxWarning, module="jdatetime") app_web = Flask(__name__) telegram_app = None # ------------------------- Ø±ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ± ÙˆØ¨ ------------------------- @app_web.route("/") def home(): """Ø±ÙˆØª Ø³Ù„Ø§Ù…Øªâ€ŒØ³Ù†Ø¬ÛŒ Ø³Ø§Ø¯Ù‡.""" return "Bot is alive and running!" @app_web.route("/telegram", methods=["POST"]) def telegram_webhook(): """ Ø±ÙˆØª Webhook Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù¾Ø¯ÛŒØªâ€ŒÙ‡Ø§. """ global telegram_app if not telegram_app: print("âŒ Bot not initialized when Webhook received an update.") return jsonify({"status": "error", "message": "Bot not initialized"}), 503 try: data = request.get_json(force=True) # â­ï¸ Ù„Ø§Ú¯ Ø¬Ø¯ÛŒØ¯: ØªØ§ÛŒÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Webhook â­ï¸ user_id = data.get('message', {}).get('from', {}).get('id', 'N/A') print(f"âœ… Webhook received update. Source: /telegram. User ID: {user_id}") update = Update.de_json(data, telegram_app.bot) loop = asyncio.get_event_loop() # Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒÙ…Ù† ØªØ§Ø¨Ø¹ async Ø¯Ø± thread Ù‡Ù…Ú¯Ø§Ù… Flask asyncio.run_coroutine_threadsafe( telegram_app.process_update(update), loop ).result() # Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÙˆÙÙ‚ØŒ Ú©Ø¯ 200 Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ… print(f"âœ… Update for User {user_id} processed successfully.") return jsonify({"status": "ok"}), 200 except Exception as e: # â­ï¸ Ù„Ø§Ú¯ Ø¬Ø¯ÛŒØ¯: Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù„ Traceback Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ â­ï¸ print(f"âŒ Error processing update: {e}") print(traceback.format_exc()) return jsonify({"status": "error", "message": str(e)}), 200 # ------------------------- ØªÙˆØ§Ø¨Ø¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ± ------------------------- async def run_flask(): """Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ± Flask Ø¨Ø§ Hypercorn.""" config = Config() port = int(os.environ.get("PORT", 10000)) config.bind = [f"0.0.0.0:{port}"] print(f"ğŸ”¥ Starting web server on port: {port} ğŸ”¥") await serve(app_web, config) async def self_ping(): """Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒÙ†Ú¯ Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®ÙˆØ§Ø¨ Ø±ÙØªÙ† Ø³Ø±ÙˆØ± (Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Render).""" import aiohttp base = os.environ.get("SELF_PING_URL") if not base: print("ğŸ’– Self-ping URL not set. Skipping self-ping task.") return interval = int(os.environ.get("SELF_PING_INTERVAL", 240)) print(f"ğŸ’– Self-ping activated every {interval} seconds to {base}") async with aiohttp.ClientSession() as session: while True: try: await session.get(base, timeout=10) except Exception as e: print(f"Self-ping failed: {e}") await asyncio.sleep(interval) async def main(): """ÙˆØ¸Ø§ÛŒÙ Ø§ØµÙ„ÛŒ: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Øª Ùˆ Ø³Ø±ÙˆØ± ÙˆØ¨ Ø¨Ù‡ ØµÙˆØ±Øª Ù‡Ù…Ø²Ù…Ø§Ù†.""" print("ğŸš€ Main server function started. Initializing bot... ğŸš€") global telegram_app # â­ï¸ Ú†Ú© Ú©Ø±Ø¯Ù† Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ â­ï¸ print(f"Environment check - BOT_TOKEN set: {'âœ… Yes' if os.environ.get('BOT_TOKEN') else 'âŒ No'}") print(f"Environment check - WEBHOOK_URL set: {'âœ… Yes' if os.environ.get('WEBHOOK_URL') else 'âŒ No (CRITICAL)'}") # Û±. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Øª (Ø¨Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªØ§Ø¨Ø¹ async main Ø§Ø² test2.py) telegram_app = await test2.main() if telegram_app is None: print("âŒ Bot application initialization failed. Server cannot run.") return # Û². ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†: Ø³Ø±ÙˆØ± ÙˆØ¨ Ùˆ Ù¾ÛŒÙ†Ú¯ flask_task = asyncio.create_task(run_flask()) tasks = [flask_task] # Ø§Ú¯Ø± Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ SELF_PING_URL ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ ØªØ³Ú© Ù¾ÛŒÙ†Ú¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ if os.environ.get("SELF_PING_URL"): ping_task = asyncio.create_task(self_ping()) tasks.append(ping_task) await asyncio.gather(*tasks) if __name__ == "__main__": try: asyncio.run(main()) except Ke
